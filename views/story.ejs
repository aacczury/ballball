<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,700' rel='stylesheet' type='text/css'>
	<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="stylesheets/bootplus.min.css" />
	<link rel="stylesheet" type="text/css" href="stylesheets/perfect-scrollbar-0.4.10.min.css" />
	<style type="text/css">
		body {
			padding: 60px 30px 40px 30px;
			margin: auto;
		}
		@media (max-width: 980px) {
			/* Enable use of floated navbar text */
			.navbar-text.pull-right {
			  float: none;
			  padding-left: 5px;
			  padding-right: 5px;
			}
		}
        #allimg { position:relative; margin:10px auto; padding:0px; height:400px; overflow: hidden; }
        #allcomment { position:relative; margin:0px auto 12px; padding:0px; height:698px; overflow: hidden; }
		.floor{ cursor: pointer }
	</style>
	<link rel="stylesheet" type="text/css" href="stylesheets/bootplus-responsive.min.css" />
</head>
<body>
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="brand" href="">胖宅の安價</a>
				<div class="nav-collapse collapse">
					<p class="navbar-text pull-right">
						Logged in as <a href="#" class="navbar-link">Username</a>
					</p>
					<ul class="nav">
						<li class="active"><a href="#">Home</a></li>
						<li><a href="#about">About</a></li>
						<li><a href="#contact">Contact</a></li>
					</ul>
				</div><!--/.nav-collapse -->
			</div>
		</div>
	</div>

	<div class="container-fluid" style="height:100%;">
		<div class="row-fluid">
			<div class="span7">
				<div class="row-fluid">
					<div id="allimg" class="span2" >
						<ul class="nav nav-list" id="imglist">
							<% var n = typeof imageN !== 'undefined' ? imageN : images.length - 1; 
							%>
							<% for(var i = 0; i < images.length; ++ i ){ %>
								<li <% if(i == n){ %>class="active"<% } %>>
									<button class="close" type="button" style="width:10px"></button>
									<a href="<%= i %>"><img style="height:100px;display: block;margin:auto;" src="uploads/thumbs/<%= images[i].name %>" /></a>
								</li>
							<% } %>
						</ul>
					</div>
					<div class="span10" >
						<div class="card">
						<% if (typeof images !== 'undefined' && images.length > 0){ 
						%>
							<div class="card-media" style="background-color:#F5F5F5;margin:16px;">
								<a class="card-media-container" id="imglink" href="uploads/fullsize/<%= images[n].name %>" target="_blank">
									<img id="imgfull" style="display: block;margin:auto;height:600px" src="uploads/fullsize/<%= images[n].name %>" alt="media"/>
								</a>
							</div>
							<div class="card-body">
								<p id="imgtext"><%= images[n].text %></p>
							</div>
						<% }; %>
						</div>
						<div class="card">
							<div class="card-body">
								<form method='post' action='/upload' enctype='multipart/form-data'>
									<input type='file' name='image'/><br/>
									<textarea name="text" style="width:95%;" rows="3"></textarea><br/>
									<button type="submit" class="btn btn-primary" data-loading-text="Sending...">Send</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div><!--/span-->
		
			<div class="span5">
				<div class="row-fluid">
					<div id="allcomment" class="span11" >
						<div id="commentHeight">
							<% var j = 0; %>
							<% if( typeof inputs !== 'undefined' && inputs.length > j && inputs[j].num == 0 ){
								%>
								<div class="alert  alert-info" style="margin-top:8px;"><%= inputs[j].text %></div>
							<% j++; }else{ %>
							<div class="getInput" style="height:22px;">
								<input type="text" alt="0" style="display:none;background-color:rgba(0,0,0,0.0);border:0px;margin:-3px 0 3px 0;">
							</div>
							<% } %>
						<% if (typeof comments !== 'undefined'){ 
						%>
							<% for(var i = 0; i < comments.length; ++ i ){ %>
							<div class="card">
								<div class="card-heading image">
									<img class="floor" id="<%= comments[i]._id %>" src="holder.js/46x46/<% if(comments[i].point){ %>lava<% }else{ %>sky<% } %>/text:<%= i+1 %>" alt="<%= i+1 %>"/>
									<div class="card-heading-header">
										<h3><%= comments[i].nickname %></h3>
									<span><%= comments[i]._id.getTimestamp() %></span>
									</div>
									<div class="card-body">
										<p><%= comments[i].content %></p>
									</div>
								</div>
								<div class="card-actions">
									<button class="btn">+1</button>
									<button class="btn">Share</button>
								</div>
							</div><!--card-->
							<% if( typeof inputs !== 'undefined' && inputs.length > j && inputs[j].num == i + 1 ){ 
								%>
							<div class="alert  alert-info" style="margin-top:8px;"><%= inputs[j].text %></div>
							<% j++; }else{ %>
							<div class="getInput" style="height:20px;margin-top:-15px">
								<input type="text" alt="<%= i+1 %>" style="display:none;background-color:rgba(0,0,0,0.0);border:0px;margin:-3px 0 3px 0;">
							</div>
							<% } %>
							<% }
						}; %>
						</div>
					</div>
				</div>
				<div class="row-fluid">
					<div class="span11">
						<div class="card">
							<h2 class="card-heading simple">喊價</h2>
							<div class="card-body">
								<!--<form action="/comment" method="post">-->
									<input id="nickname" type="text" placeholder="Nickname" name="nickname">
									<input id="content" type="text" placeholder="Content" name="content">
									<button id="commentSend" type="submit" class="btn">Send</button>
								<!--</form>-->
							</div>
						</div><!--card-->
					</div><!--/span-->
				</div><!--/row-->
			</div><!--/span-->
		</div><!--/row-->

		<hr>

		<footer>
			<p>&copy; Ballball 2014</p>
		</footer>

	</div><!--/.fluid-container-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="javascripts/bootstrap.min.js"></script>
<script src="javascripts/holder.js"></script>
<script src="javascripts/perfect-scrollbar-0.4.10.with-mousewheel.min.js"></script>
<script>
	var commentCount = <%= comments.length | 0 %>;
	var imgCount = <%= images.length | 0 %>;
	
	var socket = io.connect('http://nodejs-aczry.rhcloud.com/');
	//var socket = io.connect('http://127.0.0.1');
	
	$("#commentSend").click(function(){
		var addComment = {};
		addComment.nickname = $("#nickname").val();
		addComment.content = $("#content").val();
		socket.emit('addComment', addComment);
	});
	
	socket.on('newComment', function (comment) {
		commentCount ++;
		$("#commentHeight").append(
			"<div class=\"card\">" +
				"<div class=\"card-heading image\">" +
					"<img class=\"floor\" id=\""+ comment.id +"\" src=\"holder.js/46x46/sky/text:"+ commentCount +"\" alt=\""+ commentCount +"\"/>" +
					"<div class=\"card-heading-header\">"+
						"<h3>"+ comment.name +"</h3>"+
					"<span>"+ new Date(comment.time) +"</span>" +
					"</div>" +
					"<div class=\"card-body\">" +
						"<p>"+ comment.content +"</p>" +
					"</div>" +
				"</div>" +
				"<div class=\"card-actions\">" +
					"<button class=\"btn\">+1</button>" +
					"<button class=\"btn\">Share</button>" +
				"</div>" +
			"</div>"
		);
		Holder.run();
		$('#allcomment').animate({
			scrollTop: $('#commentHeight').height()
		}, 500);
	});
	
	$('#commentHeight').on('click', '.floor', function(event){
		var pc = {
			id : $(this).attr('id'),
			point : $(this).attr('data-src').split("/")[2] == "sky" ? true : false
		}
		socket.emit('pointComment', pc);
	});
	
	socket.on('setComment', function(pc){
		var id = "#" + pc.id;
		$(id).attr('data-src', "holder.js/46x46/"+ ( pc.point ? "lava" : "sky" ) +"/text:"+ $(id).attr('alt'));
		Holder.run();
	});
	
	$('#commentHeight').on('click', '.getInput', function(event){
		$(this).children().css("display", "").focus().focusout(function(){
			$(this).val("");
			$(this).css("display", "none");
		});
	});
	
	$('#commentHeight').on('keyup', '.getInput', function(e){
		if(e.keyCode == '13'){
			var iv = {
				num : parseInt($(this).children().attr("alt")),
				text : $(this).children().val()
			}
			socket.emit('postInput', iv);
		}
	});
	
	socket.on('getInput', function(iv){
		var d = $(".getInput").find("[alt='"+ iv.num +"']");
		d.parent().after(
			"<div class=\"alert  alert-info\" style=\"margin-top:8px;\">" + iv.text + "</div>"
		)
		d.parent().remove();
	});
	
	socket.on('getImage', function(imginfo){
		d = new Date();
		$("#imglist").find("[class='active']").attr("class", "");
		$("#imglist").append(
			"<li class=\"active\">" +
				"<button class=\"close\" type=\"button\" style=\"width:10px\"></button>" +
				"<a href=\""+ imgCount + "\"><img style=\"height:100px;display: block;margin:auto;\" src=\"uploads/thumbs/" + imginfo.name + "\" /></a>" +
			"</li>"
		)
		$('#allimg').animate({
			scrollTop: $('#imglist').height()
		}, 500);
		$("#imglink").attr("href", "uploads/fullsize/" + imginfo.name);
		$("#imgfull").attr("src", "uploads/fullsize/" + imginfo.name);
		$("#imgtext").html(imginfo.text);
		imgCount ++;
	});
	
	
	$(function(){
		$('#allimg').perfectScrollbar();
		$('#allcomment').perfectScrollbar();
		$('#allcomment').scrollTop($('#commentHeight').height());
		$('#allimg').scrollTop($('#imglist').height());
		/*
		$('#signup input[type="submit"]').click(function(e){                            
			e.preventDefault();  
			var user = {};  
			user.username = $("#username").val();  
			user.email = $("#email").val();  
			$.post("/Signup",user,function(data){  
				greet(data)                               
			});  
		});  
				 
		var greet = function(msg){
			$('#signup').html("");  
			var greeting = $('<h2>Hi,'+msg.username+',你的會員id是:'+ msg.id +'我們會將會員啟動信寄至'+msg.email+'</h2>');  
			$('#signup').append(greeting);  
		};*/
	});
</script>
</body>
</html>